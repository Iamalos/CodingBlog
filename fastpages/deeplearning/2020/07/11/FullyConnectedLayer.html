<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Fully Connected Layer | My Coding Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Fully Connected Layer" />
<meta name="author" content="Ivan Dolgushev" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Creating a fully-connected layer" />
<meta property="og:description" content="Creating a fully-connected layer" />
<link rel="canonical" href="https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html" />
<meta property="og:url" content="https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html" />
<meta property="og:site_name" content="My Coding Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-11T00:00:00-05:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ivan Dolgushev"},"description":"Creating a fully-connected layer","@type":"BlogPosting","headline":"Fully Connected Layer","dateModified":"2020-07-11T00:00:00-05:00","datePublished":"2020-07-11T00:00:00-05:00","url":"https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/CodingBlog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://iamalos.github.io/CodingBlog/feed.xml" title="My Coding Blog" /><link rel="shortcut icon" type="image/x-icon" href="/CodingBlog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Fully Connected Layer | My Coding Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Fully Connected Layer" />
<meta name="author" content="Ivan Dolgushev" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Creating a fully-connected layer" />
<meta property="og:description" content="Creating a fully-connected layer" />
<link rel="canonical" href="https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html" />
<meta property="og:url" content="https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html" />
<meta property="og:site_name" content="My Coding Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-11T00:00:00-05:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ivan Dolgushev"},"description":"Creating a fully-connected layer","@type":"BlogPosting","headline":"Fully Connected Layer","dateModified":"2020-07-11T00:00:00-05:00","datePublished":"2020-07-11T00:00:00-05:00","url":"https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://iamalos.github.io/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://iamalos.github.io/CodingBlog/feed.xml" title="My Coding Blog" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/CodingBlog/">My Coding Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/CodingBlog/about/">About Me</a><a class="page-link" href="/CodingBlog/search/">Search</a><a class="page-link" href="/CodingBlog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Fully Connected Layer</h1><p class="page-description">Creating a fully-connected layer</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-11T00:00:00-05:00" itemprop="datePublished">
        Jul 11, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Ivan Dolgushev</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/CodingBlog/categories/#fastpages">fastpages</a>
        &nbsp;
      
        <a class="category-tags-link" href="/CodingBlog/categories/#deeplearning">deeplearning</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/Iamalos/CodingBlog/tree/master/_notebooks/FullyConnectedLayer.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/CodingBlog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/Iamalos/CodingBlog/master?filepath=_notebooks%2FFullyConnectedLayer.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/CodingBlog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/Iamalos/CodingBlog/blob/master/_notebooks/FullyConnectedLayer.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/CodingBlog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/FullyConnectedLayer.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Foward-and-backward-passes">Foward and backward passes<a class="anchor-link" href="#Foward-and-backward-passes"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
   
    <span class="n">path</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="n">MNIST_URL</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.gz&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="p">(</span><span class="n">x_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span> <span class="n">x_valid</span><span class="p">,</span><span class="n">y_valid</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's grab for this example <a href="http://yann.lecun.com/exdb/mnist/">MNIST</a> data. MNIST data is a popular dataset for machine learning and deep learning and conists of handwritted digits from 0 to 9. By modern standards the dataset is considered to be trivial with many algorithms reaching &gt;99% test accuracy.</p>
<p>MNIST has a training set of 60,000 examples, and a test set of 10,000 examples.</p>
<p>There are many different ways to grab MNIST dataset. We leverage FastAI <code>datasets</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x_valid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([50000, 784]), torch.Size([10000, 784]))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our training set has 50 000 observations, each observation has 784 data points. This represents flattened 28 x 28 pixels of the resulting image. We can convert 784 vector back to a matrix form and plot it for vizualization</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Preparing-the-data">Preparing the data<a class="anchor-link" href="#Preparing-the-data"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a usual first step we normalize our data - subtract the mean and divide by the standard deviation of the <strong>train dataset</strong>. it is important to use the same mean and standard deviation while normalizing training and validation / test data</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_mean</span><span class="p">,</span> <span class="n">train_std</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">x_train</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">train_mean</span><span class="p">,</span> <span class="n">train_std</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0.1304), tensor(0.3073))</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># normalizing the data</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">train_mean</span><span class="p">,</span> <span class="n">train_std</span><span class="p">)</span>
<span class="n">x_valid</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">train_std</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_near_zero</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span> <span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Near zero: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near_zero</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">test_near_zero</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x_train</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">c</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(50000, 784, tensor(10))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Starting-version">Starting version<a class="anchor-link" href="#Starting-version"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's define the number of hidden layers</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nh</span> <span class="o">=</span> <span class="mi">50</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Initialization of weights is <strong>crucial</strong> to the training of the neural net. Using poor initialization could lead to very slow convergence of the loss function or even exploding. If weights are below 1, they will get smaller and smaller until they almost vanish and does not contribute to network learning.</p>
<p>We can look at a simplified example, inspired by <a href="https://prateekvjoshi.com/2016/03/29/understanding-xavier-initialization-in-deep-neural-networks/">post</a>, to understand why weights are important. If our input for activation <strong>z</strong> is near zero, sigmoid activation function degenerates to a linear one, which means it does not bring any new information. On the other hand, if <strong>z</strong> becomes too big or too small, activation function is flat at these areas and its gradient is approaching zero. We want the variance and bias for each layer to remain stable.</p>
<p>We  often don't worry about this as deep learning frameworks implement the necessary weights initialization under the hood, but it is still important to understand why it matters this much. I discuss weight initialization in greater details in separate posts.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">sigmoid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">sigmoid</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ \frac</span><span class="si">{1}</span><span class="s2">{1+e^{- z}}$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

<span class="n">seaborn</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;zero&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;22&#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The goal is for each layer to have mean of 0.0 and variance  of 1.0 for every layer in order to avoid gradient vanishing or exploding. This issues was tackled by Xavier in his paper <a href="http://proceedings.mlr.press/v9/glorot10a.html">Understanding the difficulty of training deep feedforward neural networks</a>.</p>
<p>Let's briefly discuss the reasoning behind his approach. <br />
Consider a fully-connected linear layer: $$ y = x * w + b$$ which is $$ y = x_{1}*w_{1} + x_{2}*w_{2} + ... + x_{N}*w_{N} + b $$.</p>
<p>Our goal is to make the variance of $y$ equal to $1$. Assuming independence between $x$ and $y$ we have the following formula:</p>
<p>
$$Var(x*y) = Var(x)*Var(y) + (Var(x)*E(y))^2 + (Var(y)*E(x))^2$$
</p>
<p>In our case $w_{i}$ was drawn from normal distrubution with zero mean and $x$ were normalized , thus for each i-th term we have:</p>
<p>
$$ Var(x_{i}*w_{i}) = Var(x_{i}) * Var(w_{i}) + (Var(x_{i})*0)^2 + (1 * 0) ^2  = Var(x_{i}) * Var(w_{i})) $$
</p>
<p>We have N identically distributed elements, thus:

$$ Var(y) = \sum_{i=1}^{N} Var(x_{i}) * Var(w_{i}) = N * Var(x_{i}) * Var(w_{i}))  $$
</p>
<p>We want our input to the activation function ($y$) to have the same variance as the previous layer ($x$) in order to have stability in the system. This implies, that</p>
$$ N * Var(w_{i}) = 1 $$<p>
$$or$$ 

$$ Var(w_{i}) = 1 / N $$
</p>
<p>This is what is called <em>Xavier</em> initialization. Let's proceed with it below.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Xavier initialization</span>
<span class="n">w1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nh</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nh</span><span class="p">)</span>
<span class="n">w2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nh</span><span class="p">)</span>
<span class="n">b2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># check that mean and variance are equal to 0 and 1</span>
<span class="n">test_near_zero</span><span class="p">(</span><span class="n">w1</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">test_near_zero</span><span class="p">(</span><span class="n">w1</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's define a simple linear layer:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">lin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> <span class="o">@</span> <span class="n">w</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0.0198), tensor(1.0244))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As we see, after applying linear layer, we succeeded in our goal - mean and variance of the input to activation function is 0 and 1 (almost). But this is not the end of the story - we have to actuall pass the results through the activation function. And the results itself will be the input to the next layer.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">relu</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">lin</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">))</span>
<span class="n">t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0.4137), tensor(0.5895))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After applying relu our mean and variance are distorted - relu clamps all negative values to zero, thus reducting variance by half and shifting mean by 0.5. We have to take into account when initializing the weigths. This is addressed by using <em>kaiming initialization</em>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># kaiming init for relu</span>
<span class="n">w1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nh</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">m</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">lin</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">))</span>
<span class="n">t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0.5944), tensor(0.8434))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is still not perfect, but is much better than the inital approach. We could also subtract 0.5 to shift mean back to 0 (relu clamped the negative values and thus distorted the mean upwards). This initialization is implemented for us in PyTorch:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">w1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nh</span><span class="p">)</span>
<span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">lin</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">b1</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0.4932), tensor(0.7707))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Unsirprisingly we get basically the same results. Note additional parameter - <code>fan_out</code>.This parameter specified either to preserve the magnitude of variance of the weights either in the forward pass (<code>fan_in</code>) or in the backwards pass (<code>fan_out</code>)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># as discussed above, we can subtract 0.5 from our relu to get mean closer to zero</span>
<span class="k">def</span> <span class="nf">relu</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our simple forward pass can be specified as follows:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">xb</span><span class="p">):</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
    <span class="n">l3</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l3</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -n 10 model(x_train)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>29.6 ms ± 4.9 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Loss-function:-MSE">Loss function: MSE<a class="anchor-link" href="#Loss-function:-MSE"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To keep things simple, we will consider MSE loss function, although in our case it does not make any practical sense</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mse</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="o">=</span><span class="n">model</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">mse</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(28.7334)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Gradients-and-backward-pass">Gradients and backward pass<a class="anchor-link" href="#Gradients-and-backward-pass"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we approach the backward pass and need to calculate the gradients of each pass. Let's start from MSE</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mse_grad</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    we accumulate gradients during the backward pass</span>
<span class="sd">    First, calculate the gradient of loss with respect to its input, which is the output of the previous layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">relu_grad</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="c1"># gradient of relu with respect to its input layer</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">lin_grad</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># grad of matmul with respect to input</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span> <span class="o">@</span> <span class="n">w</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
    <span class="c1">#w.g = (inp.unsqueeze(-1) * out.g.unsqueeze(1)).sum(0)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">@</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span>
    <span class="n">b</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">forward_and_backward</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
    <span class="c1"># forward pass:</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="n">inp</span> <span class="o">@</span> <span class="n">w1</span> <span class="o">+</span> <span class="n">b1</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">@</span> <span class="n">w2</span> <span class="o">+</span> <span class="n">b2</span>
    <span class="c1"># not necessary to compute loss</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">targ</span><span class="p">)</span>
    
    <span class="c1"># backward pass:</span>
    <span class="n">mse_grad</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">targ</span><span class="p">)</span>
    <span class="n">lin_grad</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
    <span class="n">relu_grad</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>
    <span class="n">lin_grad</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">forward_and_backward</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># save our gradients</span>
<span class="n">w1g</span> <span class="o">=</span> <span class="n">w1</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">b1g</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">w2g</span> <span class="o">=</span> <span class="n">w2</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">b2g</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">inp</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># we can check our results against pytorch</span>
<span class="n">w12</span> <span class="o">=</span> <span class="n">w1</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">b12</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">w22</span> <span class="o">=</span> <span class="n">w2</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">b22</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">xt2</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As pytorch calculates the backwards pass for us, we need only a forward pass</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="n">inp</span> <span class="o">@</span> <span class="n">w12</span> <span class="o">+</span> <span class="n">b12</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
    <span class="n">l3</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">@</span> <span class="n">w22</span> <span class="o">+</span> <span class="n">b22</span>
    <span class="k">return</span> <span class="n">mse</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span> <span class="n">targ</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">xt2</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">w22</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">w2g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">b22</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">b2g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">w12</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">w1g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">b12</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">b1g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">xt2</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So we have just checked that our gradients are correct, but the code itself is very clunky. Let's refactor it by using classes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Refactor-model">Refactor model<a class="anchor-link" href="#Refactor-model"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Layers-as-classes">Layers as classes<a class="anchor-link" href="#Layers-as-classes"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Relu</span><span class="p">():</span>
    <span class="c1"># __call__ allows us to call Relu directly as a function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">g</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Lin</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">inp</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#print(f&quot;out {self.out.g.shape}, w shape {self.w.shape}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">g</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MSE</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lin</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">),</span> <span class="n">Relu</span><span class="p">(),</span> <span class="n">Lin</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">targ</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span> <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>       
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">w1</span><span class="o">.</span><span class="n">g</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">g</span><span class="p">,</span><span class="n">w2</span><span class="o">.</span><span class="n">g</span><span class="p">,</span><span class="n">b2</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> loss = model(x_train, y_train)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 147 ms, sys: 83.6 ms, total: 230 ms
Wall time: 31.8 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> model.backward()
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 305 ms, sys: 305 ms, total: 609 ms
Wall time: 76.6 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">w2g</span><span class="p">,</span> <span class="n">w2</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">b2g</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">w1g</span><span class="p">,</span> <span class="n">w1</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">b1g</span><span class="p">,</span> <span class="n">b1</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">x_train</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Module.forward()">Module.forward()<a class="anchor-link" href="#Module.forward()"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We want to get rid of the unnecessary calls to <code>__call__</code> each time</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Module</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;not implemented&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">bwd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Relu</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span> <span class="k">return</span> <span class="n">inp</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span>
    
    <span class="k">def</span> <span class="nf">bwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span> <span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Lin</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">w</span><span class="p">,</span> <span class="n">b</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span> <span class="k">return</span> <span class="n">inp</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
    
    <span class="k">def</span> <span class="nf">bwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span>  <span class="n">inp</span><span class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">@</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MSE</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">bwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="n">inp</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">targ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lin</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">b1</span><span class="p">),</span> <span class="n">Relu</span><span class="p">(),</span> <span class="n">Lin</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">MSE</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">targ</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span> <span class="n">l</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">w1</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">b1</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">w2</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> loss = model(x_train ,y_train)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 176 ms, sys: 82.6 ms, total: 258 ms
Wall time: 34.4 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> model.backward()
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 298 ms, sys: 320 ms, total: 618 ms
Wall time: 84.3 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">w2g</span><span class="p">,</span> <span class="n">w2</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">b2g</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">w1g</span><span class="p">,</span> <span class="n">w1</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">b1g</span><span class="p">,</span> <span class="n">b1</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">x_train</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="nn.Linear-and-nn.Module">nn.Linear and nn.Module<a class="anchor-link" href="#nn.Linear-and-nn.Module"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have an understanding of how this works, we can switch to pytorch modules - <code>nn.Linear</code> and <code>nn.Module</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_in</span><span class="p">,</span> <span class="n">nh</span><span class="p">,</span> <span class="n">n_out</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_in</span><span class="p">,</span> <span class="n">nh</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="n">n_out</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">mse</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">targ</span><span class="p">)</span>        
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nh</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> loss = model(x_train, y_train)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 150 ms, sys: 38.2 ms, total: 188 ms
Wall time: 26.3 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> loss.backward()
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 258 ms, sys: 39 ms, total: 297 ms
Wall time: 37.9 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/CodingBlog/fastpages/deeplearning/2020/07/11/FullyConnectedLayer.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/CodingBlog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/CodingBlog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/CodingBlog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Blogging about Swift and Python programming</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/Iamalos" title="Iamalos"><svg class="svg-icon grey"><use xlink:href="/CodingBlog/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
